# CNC Winder Configuration for SKR Pico
# MCU Configuration
[mcu]
serial: /dev/serial/by-id/usb-Klipper_rp2040_504450612074821C-if00
baud: 250000
restart_method: command

# Emergency Stop Button
[gcode_button emergency_stop]
pin: ^!gpio22
press_gcode: M112

# Traverse Stepper (Y-axis only)
[stepper_y]
step_pin: gpio6
dir_pin: gpio5
enable_pin: !gpio7
microsteps: 16
rotation_distance: 1.0
full_steps_per_rotation: 200
endstop_pin: ^!gpio16
position_endstop: 0
position_min: 0
position_max: 93
homing_speed: 10
homing_retract_dist: 5.0
homing_retract_speed: 5

# TMC2209 Configuration for Traverse
[tmc2209 stepper_y]
uart_pin: gpio9
run_current: 0.400
hold_current: 0.100
stealthchop_threshold: 0
interpolate: False

# Printer Configuration
[printer]
kinematics: winder
max_velocity: 200
max_accel: 300

# Winder Module Configuration
[winder]
motor_pwm_pin: gpio20      # Direct connection to BLDC PWM input
motor_dir_pin: gpio3
motor_brake_pin: gpio18
motor_hall_pin: gpio24      # BLDC Hall sensor (optocoupler removed) - direct connection, no pull-up
spindle_hall_pin: ^gpio29   # NPN NO sensor - pull-up to 3.3V (^ = pull-up)
angle_sensor_pin: gpio27    # ADC angle sensor (more accurate than Hall) - ADC channel 1
gear_ratio: 0.667           # Motor 40T to Spindle 60T gear ratio
motor_poles: 8
spindle_hall_ppr: 1
wire_diameter: 0.056
bobbin_width: 12.0
spindle_edge: 38.0
traverse_max: 93.0
home_offset: 2.0
hall_sample_time: 0.01
hall_poll_time: 0.1
hall_update_rate: 10.0
max_spindle_rpm: 3300.0
max_motor_rpm: 4948.0  # 3300 / 0.667 gear ratio
min_spindle_rpm: 10.0
sync_tolerance: 0.01
sync_update_rate: 50.0

# G-code Macros
[gcode_macro HOME_TRAVERSE]
description: Home traverse and move to start position
gcode:
    G28 Y
    G1 Y50 F1000
    M117 Traverse homed and ready

[gcode_macro START_WINDING]
description: Start winding with specified RPM and layers
gcode:
    {% set rpm = params.RPM|default(100)|float %}
    {% set layers = params.LAYERS|default(1)|int %}
    
    M117 Starting winding...
    HOME_TRAVERSE
    WINDER_START RPM={rpm} LAYERS={layers}
    M117 Winding at {rpm} RPM

[gcode_macro STOP_WINDING]
description: Emergency stop winding
gcode:
    WINDER_STOP
    M117 Winding stopped

[gcode_macro CHANGE_WIRE]
description: Change wire diameter (in mm)
gcode:
    {% set diameter = params.DIAMETER|default(0.056)|float %}
    SET_WIRE_DIAMETER DIAMETER={diameter}
    M117 Wire diameter: {diameter}mm

[gcode_macro M112]
description: Emergency shutdown
rename_existing: M112.1
gcode:
    WINDER_STOP
    M112.1

[gcode_macro WINDER_INFO]
description: Report winder status
gcode:
    WINDER_STATUS

