# This file contains common pin mappings for the BIGTREETECH Manta M8P V1.1
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication.

# See docs/Config_Reference.md for a description of parameters.

# Motor1 - Reserved for BLDC motor (testing)
# Will be configured in [winder] section once testing is complete
# [stepper_x]
# step_pin: PE2
# dir_pin: PB4
# enable_pin: !PC11
# microsteps: 16
# rotation_distance: 40
# endstop_pin: ^PF3
# position_endstop: 0
# position_max: 235
# homing_speed: 50

# Motor2 - Traverse (Y-axis)
[stepper_y]
step_pin: PF12
dir_pin: PF11
enable_pin: !PB3
microsteps: 16
rotation_distance: 1.0
full_steps_per_rotation: 200
# Endstop: LED turns ON when pressed (NO switch - pulls LOW when pressed)
# Needs ^ inversion to detect LOW as triggered
endstop_pin: ^PF3
position_endstop: 0
position_min: 0
position_max: 93
homing_speed: 10
homing_retract_dist: 5.0
homing_retract_speed: 5

# Motor3 - Not used for winder
# [stepper_z]
# step_pin: PD7
# dir_pin: !PD6
# enable_pin: !PF10
# microsteps: 16
# rotation_distance: 8
# endstop_pin: ^PF5
# position_endstop: 0
# position_max: 270
# position_min: -5.0
# homing_speed: 8
# second_homing_speed: 3
# homing_retract_dist: 3

# Motor4
# The M8P only has 4 heater outputs which leaves an extra stepper
# This can be used for a second Z stepper, dual_carriage, extruder co-stepper,
# or other accesory such as an MMU
#[stepper_]
#step_pin: PD3
#dir_pin: PD2
#enable_pin: !PD5
#endstop_pin: ^PC0
#...

# Motor5 - Reserved for BLDC motor (testing)
# Will be configured in [winder] section once testing is complete
# [extruder]
# step_pin: PC9
# dir_pin: PC8
# enable_pin: !PD1
# microsteps: 16
# rotation_distance: 33.500
# nozzle_diameter: 0.4
# filament_diameter: 1.75
# heater_pin: PE3 # HE0
# sensor_pin: PA1 # T0
# sensor_type: Generic 3950
# control: pid
# pid_Kp: 22.2
# pid_Ki: 1.08
# pid_Kd: 114
# min_temp: 0
# max_temp: 250

# End-Stop 5
#[filament_switch_sensor material_0]
#switch_pin: PC1

# Motor6
#[extruder1]
#step_pin: PA10
#dir_pin: PA14
#enable_pin: !PA15 
#heater_pin: PB5 # HE1 
#sensor_pin: PA2 # T1
#...

# End-Stop 6
#[filament_switch_sensor material_1]
#switch_pin: PC2

# Motor7
#[extruder2]
#step_pin: PD11
#dir_pin: PD9
#enable_pin: !PD15
#heater_pin: PB6 # HE2
#sensor_pin: PA3 # T2
#...

# Motor8
#[extruder3]
#step_pin: PD8
#dir_pin: PC6
#enable_pin: !PC7
#heater_pin: PE1 # HE3
#sensor_pin: PA4 # T3
#...

# Heater Bed - Not used for winder
# [heater_bed]
# heater_pin: PB7
# sensor_pin: PA0 # TB 
# sensor_type: ATC Semitec 104GT-2
# control: watermark

# BLDC Motor Power Control (using bed heater port)
[output_pin bldc_motor_power]
pin: PB7   # Bed heater pin - Controls BLDC motor power supply
# Use: SET_PIN PIN=bldc_motor_power VALUE=1 to turn ON, VALUE=0 to turn OFF

# Fan0
[fan]
pin: PE6 

# Fan1
#[heater_fan fan1]
#pin: PE0

# Fan2
#[heater_fan fan2]
#pin: PC12

# Fan3
#[heater_fan fan3]
#pin: PE5

# Fan4
#[heater_fan fan4]
#pin: PE4 
#tachometer_pin: PC13

# Fan5
#[heater_fan fan5]
#pin: PB8
#tachometer_pin: PC14

# Fan6
#[heater_fan fan6]
#pin: PB9
#tachometer_pin: PC15

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_2000080012504B4633373520-if00

[printer]
kinematics: winder
max_velocity: 200
max_accel: 300

########################################
# TMC2209 configuration
########################################

# Motor1
#[tmc2209 stepper_x]
#uart_pin: PC10
##diag_pin: PF3 
#run_current: 0.800
#stealthchop_threshold: 999999

# Motor2

[tmc2209 stepper_y]
uart_pin: PF13
#diag_pin: PF4
run_current: 0.400
hold_current: 0.100
stealthchop_threshold: 0  #999999

# Motor3
#[tmc2209 stepper_z]
#uart_pin: PF9
##diag_pin: PF5
#run_current: 0.650
#stealthchop_threshold: 999999

# Motor4
#[tmc2209 stepper_]
#uart_pin: PD4
##diag_pin: PC0
#run_current: 0.650
#stealthchop_threshold: 999999

# Motor5
#[tmc2209 extruder]
#uart_pin: PD0
#run_current: 0.800
#stealthchop_threshold: 999999

# Motor6
#[tmc2209 extruder1]
#uart_pin: PF8
#run_current: 0.800
#stealthchop_threshold: 999999

# Motor7
#[tmc2209 extruder2]
#uart_pin: PD14
#run_current: 0.800
#stealthchop_threshold: 999999

# Motor8
#[tmc2209 extruder3]
#uart_pin: PD10
#run_current: 0.800
#stealthchop_threshold: 999999


[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE9, EXP1_2=PE10,
    EXP1_3=PE11, EXP1_4=PE12,
    EXP1_5=PE13, EXP1_6=PE14,    # Slot in the socket on this side
    EXP1_7=PE15, EXP1_8=PB10,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PB14, EXP2_2=PB13,
    EXP2_3=PF7, EXP2_4=PB12,
    EXP2_5=PE7, EXP2_6=PB11,      # Slot in the socket on this side
    EXP2_7=PE8, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

# See the sample-lcd.cfg file for definitions of common LCD displays.

########################################
# Winder Module Configuration
########################################

[winder]
# BLDC Motor Control Pins
# Using Motor 5 (Extruder) - All pins are PWM-capable, NO firmware modifications needed!
# Motor 5: STEP=PC9 (PWM-capable), DIR=PC8 (PWM-capable), EN=PD1 (PWM-capable)
# 
# BLDC Motor Requirements (from measurements):
# - DIR: 4.9V default, sinks to GND (LOW) to change direction
#   → MCU HIGH → Inverting level shifter → GND (LOW) = Direction change ✅
# - Brake: Needs HIGH voltage (5V) to brake, higher voltage = stronger braking
#   → MCU LOW → Inverting level shifter → 5V (HIGH) = Brake ON ✅
# - PWM: 2.5V-5V amplitude, 50Hz-20kHz frequency
motor_pwm_pin: PC9    # Motor 5 STEP - TIM3_CH4 (PWM-capable, no mods needed!)
motor_dir_pin: PC8    # Motor 5 DIR - TIM3_CH3 (PWM-capable) - MCU HIGH = GND = Direction change
motor_brake_pin: !PD1 # Motor 5 EN - TIM17_CH1 (PWM-capable) - MCU LOW = 5V = Brake ON

# Alternative: Motor 1 (X-axis) - Would need firmware modification (PE2 not PWM-capable)
# Motor 1: STEP=PE2 (NOT PWM-capable), DIR=PB4, EN=!PC11
#motor_pwm_pin: PE2    # Motor 1 STEP - Would need firmware mod (NOT recommended)
#motor_dir_pin: PB4    # Motor 1 DIR
#motor_brake_pin: !PC11 # Motor 1 EN

# Hall Sensors
spindle_hall_pin: ^PF6  # Spindle Hall sensor (with pull-up)
#motor_hall_pin:        # Motor Hall sensor (if needed, add later)

# ADC Configuration (OPTIONAL - only needed if you want to use QUERY_ADC command)
# NOTE: This is NOT used as a temperature sensor! It's only needed if you want
# to query ADC values via the QUERY_ADC G-code command. The angle sensor will
# work fine without this section - it uses ADC callbacks, not query_adc.
# Uncomment if you need QUERY_ADC command support:
# [adc_temperature angle_sensor_adc]
# sensor_pin: PB2   # Same pin as angle sensor (PB2)
# max_temp: 1000    # High value so it never triggers temperature errors

# Angle Sensor (ADC) - 12-bit Hall angle sensor
# 
# IMPORTANT: All ADC pins on MP8 have conditioning circuits that interfere with voltage dividers:
# - PA0 (TH0): Pull-up (4.7K), diodes, series resistors - interferes with dividers
# - PB2 (BLTouch): 10KΩ series resistor - makes it worse
# 
# SOLUTION: Accept saturation and use software handling:
# - Auto-calibration maps observed range (e.g., 0.04-1.0) to 0-360°
# - Hall sensor tracks revolutions during saturation gap
# - Software distinguishes stillness from rotation through saturation
# 
# This is the BEST approach given the board's design limitations.
# 
# Sensor VCC: 3.3V-3.848V (use minimum voltage that keeps sensor working)
# Higher voltage = bigger saturation gap, but sensor needs minimum to operate
# Software handles the saturation gap automatically!
angle_sensor_pin: PA0   # TH0 port (J8) - has conditioning circuit, but software handles saturation
angle_sensor_vcc: 3.848 # Actual sensor VCC voltage (for reference)
#angle_auto_calibrate: True  # Auto-calibrate min/max ADC values (default: True)
#angle_adc_min: 0.04    # Manual calibration: minimum ADC value observed (optional)
#angle_adc_max: 1.0     # Manual calibration: maximum ADC value observed (saturated, optional)

# Winder Parameters
gear_ratio: 0.667           # Motor 40T to Spindle 60T gear ratio
motor_poles: 8
spindle_hall_ppr: 1
wire_diameter: 0.056
bobbin_width: 12.0
spindle_edge: 38.0
traverse_max: 93.0
home_offset: 2.0
hall_sample_time: 0.01
hall_poll_time: 0.1
hall_update_rate: 10.0
max_spindle_rpm: 3300.0
max_motor_rpm: 4948.0  # 3300 / 0.667 gear ratio
min_spindle_rpm: 10.0
sync_tolerance: 0.01
# Reduced from 50.0 to 10.0 Hz to avoid "Timer too close" errors
# Klipper has timing constraints - can't handle too many MCU commands per second
# 10 Hz = updates every 100ms (safe for MCU, still fast enough for 43AWG wire sync)
sync_update_rate: 10.0

########################################
# G-code Macros
########################################

[gcode_macro HOME_TRAVERSE]
description: Home traverse and move to start position
gcode:
    G28 Y
    G1 Y50 F1000
    M117 Traverse homed and ready

[gcode_macro START_WINDING]
description: Start winding with specified RPM and layers
gcode:
    {% set rpm = params.RPM|default(100)|float %}
    {% set layers = params.LAYERS|default(1)|int %}
    M117 Starting winding...
    HOME_TRAVERSE
    WINDER_START RPM={rpm} LAYERS={layers}
    M117 Winding at {rpm} RPM

[gcode_macro STOP_WINDING]
description: Emergency stop winding
gcode:
    WINDER_STOP
    M117 Winding stopped

[gcode_macro CHANGE_WIRE]
description: Change wire diameter (in mm)
gcode:
    {% set diameter = params.DIAMETER|default(0.056)|float %}
    SET_WIRE_DIAMETER DIAMETER={diameter}
    M117 Wire diameter: {diameter}mm

[gcode_macro M112]
description: Emergency shutdown
rename_existing: M112.1
gcode:
    WINDER_STOP
    M112.1

[gcode_macro WINDER_INFO]
description: Report winder status
gcode:
    WINDER_STATUS

########################################
# BLTouch (commented out - using PB2 for angle sensor)
########################################

# [bltouch]
# sensor_pin: PB2  # Currently used for angle sensor
# control_pin: PB1

#[neopixel my_neopixel_1]
#pin: PA9

#[neopixel my_neopixel_2]
#pin: PB15

#[hall_filament_width_sensor]
#adc1: PC5
#adc2: PB0