# Manta M4P - CNC Guitar Pickup Winder Configuration
# Using old [winder] module format (not modular format)
#
# Hardware:
# - BLDC Motor: Nema 17, 3-phase 24V, 8 poles
# - Gear Ratio: 40:60 (motor:spindle) = 0.667
# - Hall Sensor: NPN NO, 1 pulse/revolution
# - Angle Sensor: P3022-V1-CW360, 0-5V analog, 12-bit (4096 steps)
# - Traverse: Nema 11 stepper, TMC2209 driver
# - Wire: 43 AWG copper (0.056mm diameter)

# MCU Configuration
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_*  # Auto-detected

[printer]
kinematics: winder
max_velocity: 200
max_accel: 300

# Traverse Stepper (Y-Axis) - M4P PINS
[stepper_y]
step_pin: PB10   # Y_DRIVER STEP pin (M4P)
dir_pin: PB2     # Y_DRIVER DIR pin (M4P)
enable_pin: !PB11  # Y_DRIVER EN pin (M4P)
endstop_pin: ^PC1  # Y_STOP header pin (M4P)
position_endstop: 0
position_min: 0     # Endstop is at physical limit - cannot go negative
position_max: 93
homing_speed: 20    # Increased speed for faster homing
homing_retract_dist: 5
homing_retract_speed: 10
homing_positive_dir: False  # Home in negative direction (toward position 0)
rotation_distance: 1.0  # 1.0mm lead screw pitch
microsteps: 16
full_steps_per_rotation: 200

[tmc2209 stepper_y]
uart_pin: PC10  # TMC2209 UART pin (M4P) - verified working
interpolate: True
run_current: 0.400
hold_current: 0.100
stealthchop_threshold: 999999

# Winder Module Configuration (OLD FORMAT - all in [winder] section)
[winder]
# BLDC Motor Control Pins (E0 Header - M4P)
motor_pwm_pin: PB3      # E0 STEP - PWM capable
motor_dir_pin: PB4      # E0 DIR
motor_brake_pin: PD5    # E0 ENA (HIGH = brake ON)

# Sensors - M4P PINS
spindle_hall_pin: ^PC15  # Spindle Hall sensor (M4P - NPN NO, pull-up)
angle_sensor_pin: PA0    # Angle sensor ADC (M4P - TH0 port - has voltage conditioning)

# Physical parameters
gear_ratio: 0.667       # 40:60 gear ratio (motor:spindle)
motor_poles: 8
spindle_hall_ppr: 1     # 1 pulse per revolution
wire_diameter: 0.056    # 43 AWG copper wire diameter (mm)
bobbin_width: 12.0      # Average bobbin width (mm)
spindle_edge: 38.0      # Spindle edge offset (mm)
traverse_max: 93.0       # Maximum traverse position (mm)
home_offset: 2.0         # Home offset (mm)

# Hall sensor timing
hall_sample_time: 0.01  # Sample time for frequency counter
hall_poll_time: 0.1     # Poll time for RPM updates
hall_update_rate: 10.0  # Update rate (Hz)

# Speed limits
max_spindle_rpm: 3300.0
max_motor_rpm: 4948.0   # 3300 / 0.667 gear ratio
min_spindle_rpm: 10.0

# Sync parameters
sync_tolerance: 0.01
sync_update_rate: 10.0  # Reduced to avoid "Timer too close" errors

# Angle sensor calibration
angle_sensor_vcc: 3.848  # Actual sensor VCC voltage
angle_auto_calibrate: True
# Manual calibration (optional - uncomment if needed):
# angle_adc_min: 0.04
# angle_adc_max: 1.0

# BLDC Motor Power Control (optional)
[output_pin bldc_motor_power]
pin: PB7  # Bed heater port

# Stepper Enable
[stepper_enable]

# Query ADC (for angle sensor debugging)
[query_adc]

# G-code Macros
[gcode_macro HOME_TRAVERSE]
description: Home traverse and move to start position
gcode:
    G28 Y
    G1 Y50 F1000
    M117 Traverse homed and ready

[gcode_macro START_WINDING]
description: Start winding with specified RPM and layers
gcode:
    {% set rpm = params.RPM|default(100)|float %}
    {% set layers = params.LAYERS|default(1)|int %}
    M117 Starting winding...
    HOME_TRAVERSE
    WINDER_START RPM={rpm} LAYERS={layers}
    M117 Winding at {rpm} RPM

[gcode_macro STOP_WINDING]
description: Emergency stop winding
gcode:
    WINDER_STOP
    M117 Winding stopped

[gcode_macro CHANGE_WIRE]
description: Change wire diameter (in mm)
gcode:
    {% set diameter = params.DIAMETER|default(0.056)|float %}
    SET_WIRE_DIAMETER DIAMETER={diameter}
    M117 Wire diameter: {diameter}mm

[gcode_macro M112]
description: Emergency shutdown
rename_existing: M112.1
gcode:
    WINDER_STOP
    M112.1

[gcode_macro WINDER_INFO]
description: Report winder status
gcode:
    WINDER_STATUS

