# CNC Winder Configuration for Manta M4P V2.1 (STM32G0B1)
# Based on actual Manta_M4P_V2.1 board pinout
# MCU Configuration
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_hurakan-if00


# Emergency Stop Button
# Using EXP1 header or available GPIO
[gcode_button emergency_stop]
pin: ^!PA15  # EXP1 pin, or use another available GPIO
press_gcode: M112

# Traverse Stepper (Y-axis only)
# Based on Manta M4P V2.1: Y_DRIVER uses PB11 (EN), PB10 (STEP), PB2 (DIR), PC10 (CS)
[stepper_y]
step_pin: PB10   # Y_DRIVER STEP pin from board
dir_pin: PB2     # Y_DRIVER DIR pin from board
enable_pin: !PB11  # Y_DRIVER EN pin from board
microsteps: 16
rotation_distance: 1.0
full_steps_per_rotation: 200
endstop_pin: ^!PC1  # Y_STOP header pin from board
position_endstop: 0
position_min: 0
position_max: 93
homing_speed: 10
homing_retract_dist: 5.0
homing_retract_speed: 5

# TMC2209 Configuration for Traverse
# Using UART2 header or available UART pins
[tmc2209 stepper_y]
uart_pin: PA2   # UART2 header (PA2/PA3) - adjust if using different UART
# Alternative: PA9 (USART1) from EXP1 header
run_current: 0.400
hold_current: 0.100
stealthchop_threshold: 0
interpolate: False

# Printer Configuration
[printer]
kinematics: winder
max_velocity: 200
max_accel: 300


# BLDC Motor Power Control
[output_pin motor_power]
pin: PD8   # Bed heater pin - powers BLDC motor

# E0 Header Test Pins (for LED testing)
# NOTE: Comment out [winder] pins below to test with these output_pin sections
[output_pin motor_pwm_pin]
pin: PC7   # X-axis pin

[output_pin motor_dir_pin]
pin: PC6   # X-axis pin

[output_pin motor_brake_pin]
pin: PA14   # X-axis DIR pin

# Winder Module Configuration
[winder]
# Motor Control Pins - Using E0 Stepper Driver Header (HARDWIRED)
# NOTE: Comment these out if testing with output_pin sections above
motor_pwm_pin: PD5   # E0_EN (PD5) - hardwired to E0 header
motor_dir_pin: PB4   # E0_DIR (PB4) - hardwired to E0 header
motor_brake_pin: PB3  # E0_STEP (PB3) - hardwired to E0 header

# Hall Sensor
# Using available GPIO pins - avoid pins used by board functions
motor_hall_pin: PB13  # EXP2 header or available GPIO
spindle_hall_pin: ^PB14  # EXP2 header or available GPIO (with pull-up)

# Angle Sensor (ADC) - 12-bit ADC angle sensor
# STM32G0B1 has 16 ADC channels: PA0-PA7, PB0-PB2, PB10-PB12, PC4-PC5
#
# FACTORY-SET ADC PORTS ON MANTA M4P (Perfect for angle sensor since no heaters used):
# - TH0 header (thermistor) → PA0 (ADC) ← Currently configured
# - THB header (bed thermistor) → PC4 (ADC) ← Also available
#
# Since this is a winder (no heaters), both factory ADC ports are available!
angle_sensor_pin: PA0   # TH0 header - Factory-set ADC port (12-bit, 0-4095)

# Winder Parameters
gear_ratio: 0.667           # Motor 40T to Spindle 60T gear ratio
motor_poles: 8
spindle_hall_ppr: 1
wire_diameter: 0.056
bobbin_width: 12.0
spindle_edge: 38.0
traverse_max: 93.0
home_offset: 2.0
hall_sample_time: 0.01
hall_poll_time: 0.1
hall_update_rate: 10.0
max_spindle_rpm: 3300.0
max_motor_rpm: 4948.0  # 3300 / 0.667 gear ratio
min_spindle_rpm: 10.0
sync_tolerance: 0.01
sync_update_rate: 50.0

# G-code Macros
[gcode_macro HOME_TRAVERSE]
description: Home traverse and move to start position
gcode:
    G28 Y
    G1 Y50 F1000
    M117 Traverse homed and ready

[gcode_macro START_WINDING]
description: Start winding with specified RPM and layers
gcode:
    {% set rpm = params.RPM|default(100)|float %}
    {% set layers = params.LAYERS|default(1)|int %}
    
    M117 Starting winding...
    HOME_TRAVERSE
    WINDER_START RPM={rpm} LAYERS={layers}
    M117 Winding at {rpm} RPM

[gcode_macro STOP_WINDING]
description: Emergency stop winding
gcode:
    WINDER_STOP
    M117 Winding stopped

[gcode_macro CHANGE_WIRE]
description: Change wire diameter (in mm)
gcode:
    {% set diameter = params.DIAMETER|default(0.056)|float %}
    SET_WIRE_DIAMETER DIAMETER={diameter}
    M117 Wire diameter: {diameter}mm

[gcode_macro M112]
description: Emergency shutdown
rename_existing: M112.1
gcode:
    WINDER_STOP
    M112.1

[gcode_macro WINDER_INFO]
description: Report winder status
gcode:
    WINDER_STATUS